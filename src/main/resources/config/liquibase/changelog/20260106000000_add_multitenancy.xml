<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Add tenant_id to existing tables -->
    <changeSet id="20260106000000_add_tenant_id_to_tables" author="jhipster">
        <addColumn tableName="product">
            <column name="tenant_id" type="varchar(255)" defaultValue="default_tenant">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="supplier">
            <column name="tenant_id" type="varchar(255)" defaultValue="default_tenant">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="emission_record">
            <column name="tenant_id" type="varchar(255)" defaultValue="default_tenant">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="product_passport">
            <column name="tenant_id" type="varchar(255)" defaultValue="default_tenant">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Enable RLS on tables -->
    <changeSet id="20260106000001_enable_rls" author="jhipster">
        <sql>ALTER TABLE product ENABLE ROW LEVEL SECURITY;</sql>
        <sql>ALTER TABLE supplier ENABLE ROW LEVEL SECURITY;</sql>
        <sql>ALTER TABLE emission_record ENABLE ROW LEVEL SECURITY;</sql>
        <sql>ALTER TABLE product_passport ENABLE ROW LEVEL SECURITY;</sql>
    </changeSet>

    <!-- Create RLS policies -->
    <changeSet id="20260106000002_create_rls_policies" author="jhipster">
        <sql>
            CREATE POLICY tenant_policy ON product
            USING (tenant_id = current_setting('app.current_tenant', true));
        </sql>
        <sql>
            CREATE POLICY tenant_policy ON supplier
            USING (tenant_id = current_setting('app.current_tenant', true));
        </sql>
        <sql>
            CREATE POLICY tenant_policy ON emission_record
            USING (tenant_id = current_setting('app.current_tenant', true));
        </sql>
        <sql>
            CREATE POLICY tenant_policy ON product_passport
            USING (tenant_id = current_setting('app.current_tenant', true));
        </sql>
    </changeSet>

</databaseChangeLog>
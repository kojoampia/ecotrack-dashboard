<div class="dashboard-container">
  <!-- Premium Dark Header -->
  <mat-toolbar class="h-20 backdrop-blur-xl border-b border-emerald-500/20 sticky top-0 z-50 flex justify-between px-4 md:px-12">
    <div class="flex items-center gap-3 md:gap-4 overflow-hidden">
      <div class="bg-emerald-500 p-1.5 md:p-2 rounded-xl shadow-[0_0_20px_rgba(16,185,129,0.4)] shrink-0">
        <mat-icon class="text-black scale-90 md:scale-110">eco</mat-icon>
      </div>
      <div class="flex flex-col leading-none truncate">
        <span class="text-lg md:text-xl font-black tracking-tighter text-white uppercase italic truncate">
          EcoTrack <span class="text-emerald-500">Pro</span>
        </span>
        <span class="text-[8px] md:text-[9px] font-bold text-emerald-500/60 uppercase tracking-[0.15em] mt-1 truncate">
          Global Intelligence Platform
        </span>
      </div>
    </div>

    <div class="flex items-center gap-2 md:gap-8">
      <mat-form-field appearance="outline" class="dark-select mt-4 w-32 md:w-auto" subscriptSizing="dynamic">
        <mat-select [ngModel]="selectedTenantId()" (ngModelChange)="selectedTenantId.set($event)">
          <mat-option *ngFor="let tenant of tenants; trackBy: trackByTenantId" [value]="tenant.id">{{ tenant.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-flat-button class="emerald-btn font-black text-[10px] md:text-xs tracking-widest hidden sm:flex" (click)="onExport()">
        <mat-icon class="scale-75">security</mat-icon> AUDIT EXPORT
      </button>
    </div>
  </mat-toolbar>

  <div class="dashboard-grid">
    <!-- Left Column: Stats & Table -->
    <div class="main-content">
      <!-- Stats Overview -->
      <div class="stats-grid">
        <mat-card class="stat-card total-footprint mat-elevation-z2">
          <mat-card-content class="stat-content">
            <div class="stat-icon">
              <mat-icon>cloud</mat-icon>
            </div>
            <div class="stat-details">
              <div class="stat-label">Total Footprint</div>
              <div class="stat-value">{{ totalEmissions() | number: '1.0-0' }} <span class="stat-unit">kg CO2e</span></div>
              <mat-chip class="trend-chip" color="accent" selected>
                <mat-icon>arrow_downward</mat-icon>
                4.2% vs Last Month
              </mat-chip>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card data-confidence mat-elevation-z2">
          <mat-card-content class="stat-content">
            <div class="stat-details">
              <div class="stat-label">Data Confidence</div>
              <div class="stat-value confidence-value">{{ avgConfidence() | percent: '1.0-1' }}</div>
              <div class="stat-subtext">Target >90%</div>
              <mat-progress-bar mode="determinate" [value]="avgConfidence() * 100" color="primary" class="confidence-bar">
              </mat-progress-bar>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card audit-status mat-elevation-z2">
          <mat-card-content class="stat-content">
            <div class="stat-details">
              <div class="stat-label">Audit Status</div>
              <div class="stat-value">{{ auditReadyCount() }}</div>
              <div class="stat-subtext">Verified Pings</div>
              <mat-chip class="standard-chip" color="primary" selected>
                <mat-icon>verified</mat-icon>
                ISO 14064
              </mat-chip>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Ledger Table -->
      <mat-card class="ledger-card mat-elevation-z2">
        <mat-card-header class="ledger-header">
          <mat-card-title class="ledger-title">
            <mat-icon>list_alt</mat-icon>
            Active Compliance Ledger
          </mat-card-title>
          <div class="sync-indicator">
            <mat-icon class="sync-pulse">sync</mat-icon>
            <span class="sync-text">IoT Live Sync Active</span>
          </div>
        </mat-card-header>

        <mat-card-content class="ledger-content">
          <table mat-table [dataSource]="records()" class="ledger-table">
            <!-- Classification Column -->
            <ng-container matColumnDef="classification">
              <th mat-header-cell *matHeaderCellDef>Classification</th>
              <td mat-cell *matCellDef="let record">
                <mat-chip [class]="getScopeClass(record.scope)" class="scope-chip">
                  {{ record.scope.replace('_', ' ') }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Evidence Source Column -->
            <ng-container matColumnDef="evidence">
              <th mat-header-cell *matHeaderCellDef>Evidence Source</th>
              <td mat-cell *matCellDef="let record" class="evidence-cell">
                <div class="evidence-primary">{{ record.source }}</div>
                <div class="evidence-secondary">{{ record.dateRecorded }} â€¢ UID: #{{ record.id }}</div>
              </td>
            </ng-container>

            <!-- Impact Column -->
            <ng-container matColumnDef="impact">
              <th mat-header-cell *matHeaderCellDef class="impact-header">Impact (kg)</th>
              <td mat-cell *matCellDef="let record" class="impact-cell">
                {{ record.carbonGrams / 1000 | number: '1.0-0' }}
              </td>
            </ng-container>

            <!-- Confidence Column -->
            <ng-container matColumnDef="confidence">
              <th mat-header-cell *matHeaderCellDef class="confidence-header">Confidence</th>
              <td mat-cell *matCellDef="let record" class="confidence-cell">
                <div class="confidence-container">
                  <mat-progress-bar mode="determinate" [value]="record.confidenceScore * 100" color="primary" class="confidence-bar">
                  </mat-progress-bar>
                  <span class="confidence-text">{{ record.confidenceScore | percent: '1.0-1' }}</span>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns" class="ledger-row"></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <!-- AI Compliance Insights -->
      <mat-card class="ai-insights-card mat-elevation-z2">
        <mat-card-header class="ai-header">
          <div class="ai-title-section">
            <mat-icon class="ai-sparkle">auto_awesome</mat-icon>
            <mat-card-title class="ai-title">AI Compliance Intelligence</mat-card-title>
          </div>
          <button
            mat-stroked-button
            color="primary"
            class="ai-refresh-btn"
            (click)="generateAIInsights()"
            [disabled]="isGeneratingInsights()"
          >
            <mat-icon *ngIf="isGeneratingInsights()">refresh</mat-icon>
            <mat-icon *ngIf="!isGeneratingInsights()">refresh</mat-icon>
            <span *ngIf="!isGeneratingInsights()">REFRESH INSIGHTS</span>
            <span *ngIf="isGeneratingInsights()">ANALYZING...</span>
          </button>
        </mat-card-header>

        <mat-card-content class="ai-content">
          <div *ngIf="aiInsights; else noInsights" class="insights-list">
            <div *ngFor="let insight of aiInsights()" class="insight-item">
              <div class="insight-title">{{ insight.title }}</div>
              <div class="insight-description">{{ insight.description }}</div>
            </div>
          </div>
          <ng-template #noInsights>
            <div class="no-insights">
              <mat-icon>lightbulb</mat-icon>
              <p>Click "Refresh Insights" to generate real-time reduction strategies based on current ledger data.</p>
            </div>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Right Column: AI Assistant & Tools -->
    <div class="sidebar">
      <!-- EcoAssistant - Temporarily disabled -->

      <!-- Quick Calculator -->
      <mat-card class="calculator-card mat-elevation-z2">
        <mat-card-header class="calculator-header">
          <mat-card-title class="calculator-title">Quick Calculator</mat-card-title>
        </mat-card-header>

        <mat-card-content class="calculator-content">
          <mat-form-field appearance="outline" class="calc-field">
            <mat-label>Activity (kWh)</mat-label>
            <input matInput type="number" [(ngModel)]="calcKwh" />
          </mat-form-field>

          <button mat-raised-button color="primary" class="calc-button" (click)="runCalc()">Project Impact</button>

          <div *ngIf="calcResult()" class="calc-result">
            <mat-card class="result-card">
              <mat-card-content class="result-content">
                <div class="result-label">Est. CO2e</div>
                <div class="result-value">{{ calcResult() }} kg</div>
              </mat-card-content>
            </mat-card>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- ERP Status -->
      <mat-card class="erp-card mat-elevation-z2">
        <mat-card-header class="erp-header">
          <div class="erp-title-section">
            <mat-icon class="erp-pulse">link</mat-icon>
            <span class="erp-title">Connectors</span>
          </div>
        </mat-card-header>

        <mat-card-content class="erp-content">
          <div class="connector-list">
            <div class="connector-item">
              <span class="connector-name">Oracle NetSuite</span>
              <mat-chip color="primary" selected>ACTIVE</mat-chip>
            </div>
            <div class="connector-item">
              <span class="connector-name">SAP S/4HANA</span>
              <mat-chip color="primary" selected>ACTIVE</mat-chip>
            </div>
          </div>

          <button mat-button class="manage-button">Manage Credentials</button>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container" [class.show]="showToast()">
    <mat-card class="toast-card">
      <mat-card-content class="toast-content">
        <mat-icon class="toast-icon">check_circle</mat-icon>
        <div class="toast-text">
          <div class="toast-title">Action Complete</div>
          <div class="toast-message">{{ toastMsg() }}</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

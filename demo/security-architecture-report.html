<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoTrack Pro | Security & Keycloak Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Chosen Palette: Slate & Steel Security.
         Backgrounds: Slate-50/100 (Neutral, professional).
         Primary: Blue-600 (Trust, security).
         Accents: Emerald-500 (EcoTrack consistency).
         Rationale: Security reports need to convey stability and trust. A slate-blue palette is the industry standard for cybersecurity visualizations.
    -->

    <!-- Application Structure Plan:
         1. Executive Brief: High-level overview of the security posture.
         2. Interactive Security Sequence: A CSS-based step-by-step walk-through of the OIDC flow (replaces UML).
         3. The Identity Layer: Component breakdown of Keycloak (Realms, Clients, Roles).
         4. Token Anatomy: Interactive JWT decoder simulation to show multi-tenant claims.
         5. Performance Metrics: Chart.js visualization of auth latency.
    -->

    <!-- Visualization & Content Choices:
         - Flow Diagram: HTML/CSS flexbox blocks with animated connection indicators. (NO SVG).
         - Token Decoder: Stylized JSON blocks with hover highlights to explain claims.
         - Latency Stats: Chart.js bar chart showing the overhead of centralized auth.
         - Security Matrix: Grid-based comparison of Authentication vs. Authorization.
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
      }

      .step-active {
        border-color: #2563eb;
        background-color: #eff6ff;
        color: #1e40af;
        transform: scale(1.02);
      }

      .connector-line {
        width: 2px;
        background: repeating-linear-gradient(to bottom, #cbd5e1 0, #cbd5e1 5px, transparent 5px, transparent 10px);
      }

      .chart-container {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        height: 300px;
        max-height: 400px;
      }

      .token-claim:hover {
        background-color: #dcfce7;
        cursor: help;
      }

      .pulse-emerald {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="antialiased overflow-x-hidden">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
      <!-- Header -->
      <header class="mb-12 border-b border-slate-200 pb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">
              Security & <span class="text-blue-600">Keycloak</span> Architecture
            </h1>
            <p class="mt-2 text-lg text-slate-600">Zero-Trust Multi-Tenancy for the EcoTrack Pro Ecosystem.</p>
          </div>
          <div class="flex gap-2">
            <span
              class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-bold text-blue-700 uppercase tracking-wider border border-blue-200"
              >OIDC 1.0</span
            >
            <span
              class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-bold text-emerald-700 uppercase tracking-wider border border-emerald-200"
              >OAuth 2.1</span
            >
          </div>
        </div>
      </header>

      <!-- Intro Paragraph -->
      <section class="mb-16">
        <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 leading-relaxed text-slate-700">
          <h2 class="text-xl font-bold text-slate-900 mb-4">Executive Brief</h2>
          <p>
            In the 2026 regulatory landscape, data security is as critical as the carbon data itself. This application explores how
            <strong>Keycloak</strong> serves as the centralized Identity Provider (IdP) for EcoTrack Pro. By leveraging OpenID Connect
            (OIDC), we decouple identity from application logic, allowing for seamless multi-tenant isolation through custom JWT claims.
            This report provides an interactive deep-dive into the authentication flow, role-based access control (RBAC), and the technical
            mechanism of token-based authorization.
          </p>
        </div>
      </section>

      <!-- Main Layout: Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
        <!-- LEFT: Interactive Flow (8 Cols) -->
        <div class="lg:col-span-7 space-y-10">
          <section>
            <div class="mb-6">
              <h2 class="text-2xl font-extrabold text-slate-900">Security Sequence Flow</h2>
              <p class="text-slate-600 mt-1">Interactive step-by-step walkthrough of the Authentication and Authorization cycle.</p>
            </div>

            <div class="space-y-4">
              <!-- Step 1 -->
              <div
                id="step-1"
                class="p-5 border-2 border-slate-200 rounded-xl transition-all duration-300 cursor-pointer hover:border-blue-400 group"
                onclick="setActiveStep(1)"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 group-hover:bg-blue-600 group-hover:text-white transition-colors"
                  >
                    1
                  </div>
                  <div>
                    <h4 class="font-bold text-slate-800">Authorization Request</h4>
                    <p class="text-sm text-slate-500">Angular SPA redirects user to Keycloak /auth endpoint with Client ID and Scope.</p>
                  </div>
                </div>
              </div>

              <!-- Step 2 -->
              <div
                id="step-2"
                class="p-5 border-2 border-slate-200 rounded-xl transition-all duration-300 cursor-pointer hover:border-blue-400 group"
                onclick="setActiveStep(2)"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 group-hover:bg-blue-600 group-hover:text-white transition-colors"
                  >
                    2
                  </div>
                  <div>
                    <h4 class="font-bold text-slate-800">Primary Authentication</h4>
                    <p class="text-sm text-slate-500">Keycloak verifies credentials against the DB and extracts Tenant Metadata.</p>
                  </div>
                </div>
              </div>

              <!-- Step 3 -->
              <div
                id="step-3"
                class="p-5 border-2 border-slate-200 rounded-xl transition-all duration-300 cursor-pointer hover:border-blue-400 group"
                onclick="setActiveStep(3)"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 group-hover:bg-blue-600 group-hover:text-white transition-colors"
                  >
                    3
                  </div>
                  <div>
                    <h4 class="font-bold text-slate-800">Token Issuance (JWT)</h4>
                    <p class="text-sm text-slate-500">
                      Keycloak issues a signed JWT containing <code>tenant_id</code> and <code>resource_access</code> roles.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Step 4 -->
              <div
                id="step-4"
                class="p-5 border-2 border-slate-200 rounded-xl transition-all duration-300 cursor-pointer hover:border-blue-400 group"
                onclick="setActiveStep(4)"
              >
                <div class="flex items-center gap-4">
                  <div
                    class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-500 group-hover:bg-blue-600 group-hover:text-white transition-colors"
                  >
                    4
                  </div>
                  <div>
                    <h4 class="font-bold text-slate-800">Backend Authorization</h4>
                    <p class="text-sm text-slate-500">Spring Boot validates signature via JWKS and filters data using JWT claims.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Flow Terminal Output -->
            <div class="mt-8 bg-slate-900 rounded-xl p-6 font-mono text-xs overflow-hidden shadow-lg border border-slate-700">
              <div class="flex gap-2 mb-4">
                <div class="w-3 h-3 rounded-full bg-rose-500"></div>
                <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
              </div>
              <div id="console-output" class="text-emerald-400 min-h-[80px]">
                // Click a step above to simulate the protocol exchange...
              </div>
            </div>
          </section>

          <section>
            <div class="mb-6">
              <h2 class="text-2xl font-extrabold text-slate-900">Auth Performance Benchmarks</h2>
              <p class="text-slate-600 mt-1">Analyzing the latency impact of centralized security calls vs. direct access.</p>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-200">
              <div class="chart-container">
                <canvas id="performanceChart"></canvas>
              </div>
            </div>
          </section>
        </div>

        <!-- RIGHT: Token Decoder & Details (5 Cols) -->
        <div class="lg:col-span-5 space-y-10">
          <!-- Token Anatomy Section -->
          <section class="sticky top-10">
            <div class="mb-6">
              <h2 class="text-2xl font-extrabold text-slate-900">JWT Anatomy</h2>
              <p class="text-slate-600 mt-1">Hover over claims to understand how they drive the RLS security layer.</p>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-6 shadow-inner font-mono text-[13px] leading-relaxed">
              <div class="text-rose-600 mb-2 font-bold">// Header</div>
              <div class="text-slate-400">{ "alg": "RS256", "typ": "JWT" }</div>

              <div class="text-blue-600 mt-4 mb-2 font-bold">// Payload (Claims)</div>
              <div class="text-slate-800">
                {<br />
                &nbsp;&nbsp;"sub": "f626a...78d",<br />
                &nbsp;&nbsp;<span class="token-claim p-0.5 rounded transition-colors" onmouseover="explainClaim('tenant')"
                  >"tenant_id": "tenant_steel_001"</span
                >,<br />
                &nbsp;&nbsp;<span class="token-claim p-0.5 rounded transition-colors" onmouseover="explainClaim('role')"
                  >"roles": ["COMPLIANCE_OFFICER"]</span
                >,<br />
                &nbsp;&nbsp;<span class="token-claim p-0.5 rounded transition-colors" onmouseover="explainClaim('exp')"
                  >"exp": 1736802400</span
                >,<br />
                &nbsp;&nbsp;"iss": "keycloak.ecotrack.pro"<br />
                }
              </div>

              <div
                id="claim-explanation"
                class="mt-6 bg-white p-4 rounded-xl border border-blue-100 text-xs text-blue-800 italic animate-in slide-in-from-top-2"
              >
                Select a highlighted claim to see its security impact.
              </div>
            </div>

            <!-- Authorization Legend -->
            <div class="mt-10 bg-white p-6 rounded-2xl border border-slate-200">
              <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500 pulse-emerald"></span>
                Authorization Mapping
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 p-4 rounded-xl">
                  <div class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">User Role</div>
                  <div class="text-sm font-bold text-slate-700">Auditor</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                  <div class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Scope</div>
                  <div class="text-sm font-bold text-slate-700">READ_ONLY</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                  <div class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">User Role</div>
                  <div class="text-sm font-bold text-slate-700">Admin</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl">
                  <div class="text-[10px] font-black uppercase text-slate-400 tracking-widest mb-1">Scope</div>
                  <div class="text-sm font-bold text-slate-700">FULL_WRITE</div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-20 pt-10 border-t border-slate-200 text-center text-slate-400 text-sm">
        <p>Â© 2026 EcoTrack Pro - Internal Security Documentation v2.0</p>
        <p class="mt-1">ISO 27001 & SOC2 Compliance Ready Instrumentation</p>
      </footer>
    </div>

    <script>
      // --- DATA & STATE ---
      const stepLogs = {
        1: 'GET /auth?client_id=ecotrack-spa&response_type=code&scope=openid%20profile\n>> Redirecting user to IDP login page...',
        2: "POST /login (username, password)\n>> Authenticating with master realm...\n>> Success. Tenant context 'tenant_steel_001' found.",
        3: 'Generating JWT with RS256 signature...\n>> Claims: sub, iss, exp, tenant_id, resource_access\n>> Returning Auth Code to Callback...',
        4: "Exchange Code for Token (Back-channel)\n>> Backend validating signature with RSA Public Key...\n>> Security Context initialized: SET app.current_tenant = 'tenant_steel_001';",
      };

      const claimInfo = {
        tenant:
          "The most critical claim. Spring Boot extracts this and executes 'SET app.current_tenant' at the DB session level, enabling Row-Level Security isolation.",
        role: 'Determines functional access. Used by @PreAuthorize annotations to restrict specific API endpoints (e.g., Export vs Read).',
        exp: 'Standard expiration claim. Ensures tokens are short-lived, forcing frequent re-authentication via Refresh Tokens.',
      };

      // --- CHART INITIALIZATION ---
      function initCharts() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Token Refresh', 'Introspection', 'Signature Validation', 'RLS Injection'],
            datasets: [
              {
                label: 'Latency (ms)',
                data: [12, 45, 2, 8],
                backgroundColor: ['rgba(37, 99, 235, 0.7)', 'rgba(37, 99, 235, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(16, 185, 129, 0.7)'],
                borderRadius: 8,
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Milliseconds' },
                grid: { color: '#f1f5f9' },
              },
              x: { grid: { display: false } },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }

      // --- INTERACTION HANDLING ---
      function setActiveStep(stepId) {
        // UI Reset
        for (let i = 1; i <= 4; i++) {
          document.getElementById(`step-${i}`).classList.remove('step-active');
        }

        // Set Active
        const el = document.getElementById(`step-${stepId}`);
        el.classList.add('step-active');

        // Console Output
        const consoleBox = document.getElementById('console-output');
        consoleBox.innerHTML = '';

        let lines = stepLogs[stepId].split('\n');
        let i = 0;

        function typeLine() {
          if (i < lines.length) {
            consoleBox.innerHTML += (i === 0 ? '' : '<br>') + lines[i];
            i++;
            setTimeout(typeLine, 50);
          }
        }
        typeLine();
      }

      function explainClaim(type) {
        const box = document.getElementById('claim-explanation');
        box.innerText = claimInfo[type];
        box.classList.remove('animate-in', 'slide-in-from-top-2');
        void box.offsetWidth; // Trigger reflow
        box.classList.add('animate-in', 'slide-in-from-top-2');
      }

      // --- INITIALIZE ---
      window.onload = () => {
        initCharts();
        setActiveStep(1);
      };
    </script>
  </body>
</html>

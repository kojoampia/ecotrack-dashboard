# EcoTrack Pro: AI Coding Agent Instructions

**Project**: EcoTrack Pro – Carbon compliance and emission tracking platform
**Stack**: Spring Boot 3.4 + JHipster 8.0 monolith, Angular 16+ frontend, PostgreSQL 16
**Domain**: Environmental/regulatory compliance (CBAM, Scope 1/2/3 emissions)

## Architecture Overview

### Core Principles
- **JHipster Monolith**: Generated via JHipster; follows standard Spring Boot layering (Controller → Service → Repository → Domain).
- **Multi-Tenant with Row-Level Security (RLS)**: PostgreSQL enforces tenant isolation at the database layer via `tenant_id` session variables, NOT just application-level filtering. This is a critical security boundary.
- **API-First Development**: OpenAPI spec at `src/main/resources/swagger/api.yml` drives generation. Use `./mvnw generate-sources` to regenerate delegates.

### Key Packages & Responsibilities
- `com.ecotrack.app.domain`: JPA entities (Product, EmissionRecord, Supplier, EmissionEvidence, ComplianceReport, etc.)
- `com.ecotrack.app.repository`: Spring Data JPA; must include RLS-safe queries (e.g., `@Query` with tenant context)
- `com.ecotrack.app.service.impl`: Business logic; critical services include:
  - `CarbonCalculationServiceImpl`: GHG Protocol calculations with dynamic grid intensity
  - `ComplianceReportServiceImpl`: Report generation for regulatory submission
  - `CompliancePayloadServiceImpl`: CBAM-ready XML generation
  - `ProductServiceImpl`, `EmissionRecordServiceImpl`: Core entity operations
- `com.ecotrack.app.web.rest`: REST controllers; auto-generated from OpenAPI; implement delegates here
- `com.ecotrack.app.config`: Spring Security (OAuth2/OIDC via Keycloak), Liquibase, caching, observability
- `com.ecotrack.app.security`: Authority constants, custom filters

### Frontend Structure
- `src/main/webapp/app/`: Angular 16+ standalone components + shared modules
  - `carbon-dashboard/`: Main dashboard for emission visualization
  - `entities/`: CRUD modules (auto-generated by JHipster)
  - `admin/`, `account/`, `login/`: Authentication & administration
  - `shared/`: Common services, interceptors, auth guards
  - `config/`: HTTP client setup, environment overrides
- **UI Framework**: Angular Material M3 with Material Icons (replaces Bootstrap/FontAwesome)

## Critical Developer Workflows

### Local Development
```bash
# Start database & Keycloak (first time or after schema changes):
npm run services:up
npm run docker:db:up

# Terminal 1: Backend (auto-reload on Java/YAML changes)
./mvnw

# Terminal 2: Frontend (HMR enabled)
npm start
```
**App runs on**: Backend `http://localhost:8080`, Frontend dev server proxies to backend.

### Testing
```bash
npm run ci:backend:test    # JUnit5 + Checkstyle + Javadoc + ArchUnit
npm run ci:frontend:test   # Jest (TESTS-results-jest.xml in target/test-results/)
npm run jest               # Frontend unit tests with coverage
```

### Code Generation & Compilation
```bash
./mvnw generate-sources    # Regenerate from OpenAPI spec
./mvnw spotless:apply      # Auto-format Java/YAML (enforced in CI)
npm run prettier:format    # Format TypeScript/HTML/SCSS
npm run lint:fix           # Fix ESLint issues
```

### Building for Production
```bash
npm run java:jar:prod      # JAR in target/
npm run java:docker:prod   # Docker image (ecotrackpro:latest)
npm run build              # Full frontend optimization
```

### Debugging
- **Backend**: `npm run backend:debug` starts JVM with JDWP on port 8000
- **Frontend**: Chrome DevTools (Angular app includes source maps in dev)
- **Database**: Connect directly to PostgreSQL on port 5432 (user: EcoTrackPro, pw: in docker-compose)

## Observability & Monitoring
- **Metrics**: Prometheus (port 9090) scrapes Spring Boot actuator at `/management/prometheus`
- **Dashboards**: Grafana (port 3000, admin/admin) with pre-provisioned datasources
- **Logs**: Logback with structured logging; `CRLFLogConverter` for Windows CRLF handling
- **Profiles**: Use `-Dlogging.level.com.ecotrack.app=DEBUG` to increase logging in CI/tests

## Multi-Tenancy & Security

### Critical: Row-Level Security
- Every JPA query MUST respect `tenant_id` session variable set by `SecurityConfiguration`
- Do NOT apply tenant filtering in Java—rely on PostgreSQL RLS policies
- Test multi-tenant isolation with fixtures: `tenant_steel_001`, `tenant_green_002` (see `EcoTrack_Pro_Project_v2026/demo/`)

### Authentication
- OAuth2 Resource Server using Spring Security (JWT or OIDC via Keycloak)
- Endpoints require `@PreAuthorize` or matching authority (e.g., `AuthoritiesConstants.ADMIN`)
- Public endpoints: `/api/authenticate`, `/api/register`, `/api/activate`, swagger/actuator health

### Environment Configuration
- **Dev**: `application.yml` + `application-dev.yml` (in-memory H2 or local PostgreSQL)
- **Prod**: `application-prod.yml` with env vars for DB URL, JWT secret, mail host
- Use Spring profiles: `--spring.profiles.active=prod,faker` to load fake data in production

## Project-Specific Patterns

### Carbon Calculation Engine
- **Scope Classification**: `SCOPE_1` (on-site), `SCOPE_2` (purchased electricity), `SCOPE_3` (supply chain)
- **Data Quality**: EmissionRecord includes `confidenceScore` (1–100 scale) for uncertainty quantification
- **Grid Intensity**: Dynamic sync with regional energy grid APIs; stored in Redis for performance
- **Hybrid Input**: Prioritize IoT meter data (confidence 1.0); fall back to spend-based estimation (confidence 0.5)

### Entity Relationships
- `Product` → `Supplier` (many-to-one)
- `Product` ↔ `EmissionRecord` (one-to-many; scope + unit conversion in calculation)
- `EmissionRecord` → `EmissionEvidence` (one-to-many; audit trail)
- All entities include `createdDate`, `lastModifiedDate` via Auditable superclass

### Reporting & Compliance
- **JasperReports**: Embedded verification hashes for PDF generation
- **CBAM Payload**: XML/XSD generation from structured emission data
- **Liquibase**: Changelog-driven migrations in `src/main/resources/config/liquibase/changelog/`

## Dependency & Version Management

### Key Versions (from pom.xml)
- JHipster: 8.0.0
- Spring Boot: 3.1.5
- Hibernate: 6.2.13.Final
- MapStruct: 1.5.5.Final (for DTO mappers)
- Liquibase: 4.24.0
- Angular: 16.2.9 (check package.json for exact version)

### Common Dependencies
- **DTO Mapping**: Use MapStruct `@Mapper` for entity ↔ DTO conversions
- **Validation**: `javax.validation` annotations on entities
- **OpenAPI**: `springdoc-openapi-starter-webmvc-api` auto-generates `/v3/api-docs`

## File Locations & Examples

| Pattern | Location | Purpose |
|---------|----------|---------|
| Entity definition | `src/main/java/domain/Product.java` | JPA entity + validations |
| Repository | `src/main/java/repository/ProductRepository.java` | Spring Data interface |
| Service interface | `src/main/java/service/ProductService.java` | Business logic contract |
| Service impl | `src/main/java/service/impl/ProductServiceImpl.java` | Implementation |
| REST controller | `src/main/java/web/rest/ProductResource.java` | HTTP endpoints (delegate pattern) |
| DTO | `src/main/java/service/dto/ProductDTO.java` | Transfer object |
| DTO mapper | `src/main/java/service/mapper/ProductMapper.java` | MapStruct interface |
| Angular service | `src/main/webapp/app/entities/product/service/product.service.ts` | API client |
| Angular component | `src/main/webapp/app/entities/product/list/` | UI |
| Integration test | `src/test/java/web/rest/ProductResourceIT.java` | Full stack tests |
| Unit test | `src/test/java/service/ProductServiceTest.java` | Service logic tests |

## CI/CD & Deployment
- **Maven profiles**: `-Pdev`, `-Pprod`, `-Pwar`, `-Pe2e`
- **Docker**: Uses Jib plugin; `docker-compose -f src/main/docker/app.yml up` for full stack
- **E2E tests**: Run with `-Pe2e` profile; orchestrated via `docker-compose -f src/main/docker/services.yml`
- **Checkstyle**: Enforced on all Java files; run `./mvnw checkstyle:check` to validate

## Common Pitfalls & Solutions

1. **RLS Violations**: Always verify tenant_id context is set in SecurityConfiguration before querying
2. **OpenAPI Out of Sync**: Regenerate delegates with `./mvnw generate-sources` when API spec changes
3. **Frontend Build Failures**: Clear `node_modules` and `target/classes/static/` if HMR breaks
4. **Database Lock**: Liquibase may hang if migrations fail; check logs and rollback manually if needed
5. **E2E Timeouts**: Docker containers must be healthy before tests run; use `--wait` flag

## Material Icons & Components
- **Icons**: Use `<mat-icon>icon_name</mat-icon>` instead of FontAwesome (Material Icons are built-in)
- **Common conversions**: `menu`, `home`, `show_chart`, `description`, `list`, `star`, `groups`, `people`, `dashboard`, `favorite`, `settings`, `done_all`, `menu_book`, `flag`, `person`, `build`, `lock`, `logout`, `login`, `person_add`, `close`, `save`, `check`, `refresh`, `arrow_back`, `unfold_more`
- **Material Modules**: Menu, Dialog, Button, Icon, Chip, Card, Form controls already integrated in [shared.module.ts](src/main/webapp/app/shared/shared.module.ts)
- **Theming**: M3 emerald palette configured in [global.scss](src/main/webapp/content/scss/global.scss)

## References
- [JHipster 8.0 Docs](https://www.jhipster.tech/documentation-archive/v8.0.0)
- [Spring Boot 3.1 Reference](https://docs.spring.io/spring-boot/docs/3.1.5/reference/html/)
- [Angular 16 Guide](https://angular.io/guide/setup-local)
- [OpenAPI Generator](https://openapi-generator.tech/)

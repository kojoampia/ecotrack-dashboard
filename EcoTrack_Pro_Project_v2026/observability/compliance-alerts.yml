groups:
  - name: EcoTrackProCompliance
    rules:
      # 1. Critical Availability: Alert if Gemini API is unreachable globally
      - alert: GlobalAIServiceDown
        expr: probe_success{job="blackbox_ai"} == 0
        for: 1m
        labels:
          severity: critical
          domain: infrastructure
        annotations:
          summary: 'Global AI API Outage Detected'
          description: 'The Blackbox probe for {{ $labels.instance }} has failed. AI-driven compliance strategies are currently offline.'

      # 2. Compliance: Data Integrity Threshold
      - alert: CarbonConfidenceBelowThreshold
        expr: avg by (tenant_id) (carbon_confidence_score) < 0.92
        for: 5m
        labels:
          severity: critical
          domain: compliance
        annotations:
          summary: 'Low confidence score for tenant {{ $labels.tenant_id }}'
          description: 'Average confidence ({{ $value | printf "%.2f" }}) is below the 92% regulatory threshold.'

      # 3. Performance: AI Latency Warning
      - alert: AIServiceHighLatency
        expr: histogram_quantile(0.95, sum(rate(ai_request_duration_seconds_bucket[5m])) by (le)) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'AI Insight generation is slow'
          description: 'p95 latency for Gemini requests is currently {{ $value }}s.'

      # 4. Financial: Real-time Daily Budget Breach (Redis-enforced)
      - alert: CarbonBudgetBreach
        expr: sum by (tenant_id) (increase(ai_budget_exceeded_total[15m])) > 0
        for: 0m
        labels:
          severity: critical
          domain: finance
        annotations:
          summary: 'Daily AI Budget Exhausted'
          description: 'Tenant {{ $labels.tenant_id }} has reached their daily USD limit. Circuit breaker has tripped for AI services.'

      # 5. Financial: Accrued Monthly Bill Warning
      # Threshold set to $5,000 based on Tier 1 limits
      - alert: TenantMonthlyBudgetExceeded
        expr: |
          sum by (tenant_id) (
            increase(carbon_calculation_total[30d]) * 0.05 + 
            increase(ai_strategies_generated_total[30d]) * 2.00 + 
            increase(ai_simulations_run_total[30d]) * 0.50 + 
            increase(cbam_reports_generated_total[30d]) * 150.00
          ) > 5000
        for: 1h
        labels:
          severity: warning
          domain: finance
        annotations:
          summary: 'Monthly Subscription Limit Approaching'
          description: 'Tenant {{ $labels.tenant_id }} has accrued over $5,000 in billable units this month. Current estimated bill: ${{ $value | printf "%.2f" }}.'
